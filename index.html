<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานผู้หมดสิทธิ์สอบ (Multi-entry)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1a73e8; --success: #188038; --danger: #d93025; --bg: #f8f9fa; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 650px; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section-title { background: #e8f0fe; padding: 10px; border-radius: 5px; margin-top: 20px; font-weight: bold; color: var(--primary); }
        
        label { display: block; margin-top: 15px; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .calc-result { background: #f1f3f4; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 5px solid var(--primary); }
        .calc-result span { font-weight: bold; color: var(--primary); }
        .low-percent { color: var(--danger) !important; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 25px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-add-next { background: var(--success); color: white; } /* ส่งแล้วกรอกคนต่อไป */
        .btn-reset { background: #e0e0e0; color: #555; } /* เริ่มใหม่ทั้งหมด */
        
        #loading { display: none; text-align: center; color: var(--primary); font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <form id="attendanceForm">
        <h2>ระบบบันทึกข้อมูลการมาเรียน</h2>

        <div class="section-title">ข้อมูลครูและรายวิชา (กรอกครั้งเดียว)</div>
        <div class="grid-2">
            <div>
                <label>ชื่อครูผู้สอน</label>
                <input type="text" id="teacherName" placeholder="ชื่อ-นามสกุล" required>
            </div>
            <div>
                <label>กลุ่มสาระฯ</label>
                <select id="department">
                    <option value="คณิตศาสตร์">คณิตศาสตร์</option>
                    <option value="วิทยาศาสตร์ฯ">วิทยาศาสตร์ฯ</option>
                    <option value="ภาษาไทย">ภาษาไทย</option>
                    <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
                </select>
            </div>
        </div>

        <div class="grid-3">
            <div><label>รหัสวิชา</label><input type="text" id="courseID" required></div>
            <div style="grid-column: span 2;"><label>ชื่อรายวิชา</label><input type="text" id="courseName" required></div>
        </div>
        <label>ชั้น/ห้อง</label>
        <input type="text" id="classRoom" placeholder="ม.6/1" required>

        <div class="section-title" style="background: #e6ffed; color: #188038;">ข้อมูลนักเรียน (กรอกรายคน)</div>
        <div class="grid-2">
            <div><label>เลขประจำตัว</label><input type="text" id="studentID" required></div>
            <div><label>ชื่อ-นามสกุลนักเรียน</label><input type="text" id="studentName" required></div>
        </div>

        <label>เวลาเรียนทั้งหมด (ชั่วโมง)</label>
        <input type="number" id="totalTime" value="40" oninput="calculate()">

        <div class="grid-3">
            <div><label>ขาด</label><input type="number" id="absent" value="0" oninput="calculate()"></div>
            <div><label>ลา</label><input type="number" id="leave" value="0" oninput="calculate()"></div>
            <div><label>ป่วย</label><input type="number" id="sick" value="0" oninput="calculate()"></div>
        </div>

        <div class="calc-result">
            รวมมาเรียน: <span id="presentText">40</span> ชม. | 
            คิดเป็น: <span id="percentText">100.00</span>%
            <div id="statusNote" style="font-size: 0.85em; margin-top:5px;"></div>
        </div>

        <div id="loading">กำลังบันทึกข้อมูล...</div>

        <div class="btn-group">
            <button type="submit" class="btn-add-next">บันทึกข้อมูลและเพิ่มนักเรียนคนถัดไป ➔</button>
            <button type="button" class="btn-reset" onclick="resetAll()">เริ่มวิชาใหม่ / ล้างข้อมูลทั้งหมด</button>
        </div>
    </form>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxRJ13bWTXhbr2aWQ3auA86Hwc2xro1X-HKs4bbXQOsKta3R3RSJtcLblVDAK_n8Yq8/exec';

    function calculate() {
        const total = parseFloat(document.getElementById('totalTime').value) || 0;
        const absent = parseFloat(document.getElementById('absent').value) || 0;
        const leave = parseFloat(document.getElementById('leave').value) || 0;
        const sick = parseFloat(document.getElementById('sick').value) || 0;

        const present = total - (absent + leave + sick);
        const percentage = total > 0 ? (present / total) * 100 : 0;

        document.getElementById('presentText').innerText = present;
        const pText = document.getElementById('percentText');
        pText.innerText = percentage.toFixed(2);

        const statusNote = document.getElementById('statusNote');
        if (percentage < 80) {
            pText.className = 'low-percent';
            statusNote.innerText = '⚠️ หมดสิทธิ์สอบ (ต่ำกว่า 80%)';
            statusNote.style.color = '#d93025';
        } else {
            pText.className = '';
            statusNote.innerText = '✅ มีสิทธิ์สอบ';
            statusNote.style.color = '#188038';
        }
    }

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        document.getElementById('loading').style.display = 'block';
        const submitBtn = document.querySelector('.btn-add-next');
        submitBtn.disabled = true;

        const data = {
            teacher: document.getElementById('teacherName').value,
            dept: document.getElementById('department').value,
            courseID: document.getElementById('courseID').value,
            courseName: document.getElementById('courseName').value,
            class: document.getElementById('classRoom').value,
            studentID: document.getElementById('studentID').value,
            studentName: document.getElementById('studentName').value,
            total: document.getElementById('totalTime').value,
            absent: document.getElementById('absent').value,
            leave: document.getElementById('leave').value,
            sick: document.getElementById('sick').value,
            present: document.getElementById('presentText').innerText,
            percent: document.getElementById('percentText').innerText
        };

        fetch(scriptURL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' })
        .then(() => {
            alert('บันทึกข้อมูลของ ' + data.studentName + ' เรียบร้อย');
            
            // ล้างข้อมูลเฉพาะส่วนนักเรียน เพื่อกรอกคนถัดไป
            document.getElementById('studentID').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('absent').value = '0';
            document.getElementById('leave').value = '0';
            document.getElementById('sick').value = '0';
            calculate();
            
            document.getElementById('loading').style.display = 'none';
            submitBtn.disabled = false;
            document.getElementById('studentID').focus(); // เลื่อนไปช่องเลขประจำตัวอัตโนมัติ
        })
        .catch(err => {
            alert('เกิดข้อผิดพลาด!');
            document.getElementById('loading').style.display = 'none';
            submitBtn.disabled = false;
        });
    });

    function resetAll() {
        if(confirm('คุณต้องการล้างข้อมูลทั้งหมดเพื่อเริ่มวิชาใหม่ใช่หรือไม่?')) {
            location.reload();
        }
    }
</script>

</body>
</html>