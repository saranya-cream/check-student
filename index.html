<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานผลการมาเรียน (8 กลุ่มสาระ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1a73e8; --success: #188038; --danger: #d93025; --bg: #f8f9fa; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; width: 100%; max-width: 650px; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section-title { background: #e8f0fe; padding: 10px; border-radius: 5px; margin-top: 20px; font-weight: bold; color: var(--primary); }
        
        label { display: block; margin-top: 15px; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        /* สไตล์พิเศษสำหรับ คำนำหน้า + ชื่อ */
        .name-group { display: grid; grid-template-columns: 120px 1fr; gap: 10px; }

        .calc-result { background: #f1f3f4; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 5px solid var(--primary); }
        .calc-result span { font-weight: bold; color: var(--primary); }
        .low-percent { color: var(--danger) !important; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 25px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-add-next { background: var(--success); color: white; }
        .btn-reset { background: #e0e0e0; color: #555; }
        
        #loading { display: none; text-align: center; color: var(--primary); font-weight: bold; margin-top: 10px; }

        /* สไตล์ตารางสรุป */
        .summary-container { background: white; width: 100%; max-width: 650px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
        th { background: #fafafa; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <form id="attendanceForm">
        <h2>ระบบบันทึกข้อมูลการมาเรียน</h2>

        <div class="section-title">ข้อมูลครูและรายวิชา</div>
        <label>ชื่อครูผู้สอน</label>
        <input type="text" id="teacherName" placeholder="ระบุชื่อ-นามสกุล" required>

        <label>กลุ่มสาระการเรียนรู้</label>
        <select id="department" required>
            <option value="" disabled selected>--- เลือกกลุ่มสาระฯ ---</option>
            <option value="คณิตศาสตร์">คณิตศาสตร์</option>
            <option value="ภาษาไทย">ภาษาไทย</option>
            <option value="วิทยาศาสตร์และเทคโนโลยี">วิทยาศาสตร์และเทคโนโลยี</option>
            <option value="สังคมศึกษา ศาสนา และวัฒนธรรม">สังคมศึกษา ศาสนา และวัฒนธรรม</option>
            <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
            <option value="การงานอาชีพ">การงานอาชีพ</option>
            <option value="สุขศึกษาและพลศึกษา">สุขศึกษาและพลศึกษา</option>
            <option value="ศิลปะ">ศิลปะ</option>
        </select>

        <div class="grid-3">
            <div><label>รหัสวิชา</label><input type="text" id="courseID" required></div>
            <div style="grid-column: span 2;"><label>ชื่อรายวิชา</label><input type="text" id="courseName" required></div>
        </div>
        <label>ชั้น/ห้อง</label>
        <input type="text" id="classRoom" placeholder="เช่น ม.6/1" required>

        <div class="section-title" style="background: #e6ffed; color: #188038;">ข้อมูลนักเรียน</div>
        <div class="grid-2">
            <div><label>เลขประจำตัว</label><input type="text" id="studentID" required></div>
            <div class="name-group">
                <div>
                    <label>คำนำหน้า</label>
                    <select id="title" required>
                        <option value="เด็กชาย">เด็กชาย</option>
                        <option value="เด็กหญิง">เด็กหญิง</option>
                        <option value="นาย">นาย</option>
                        <option value="นางสาว">นางสาว</option>
                    </select>
                </div>
                <div>
                    <label>ชื่อ-นามสกุลนักเรียน</label>
                    <input type="text" id="studentName" required>
                </div>
            </div>
        </div>

        <label>เวลาเรียนทั้งหมด (ชั่วโมง)</label>
        <input type="number" id="totalTime" value="40" oninput="calculate()" required>

        <div class="grid-3">
            <div><label>ขาด</label><input type="number" id="absent" value="0" oninput="calculate()"></div>
            <div><label>ลา</label><input type="number" id="leave" value="0" oninput="calculate()"></div>
            <div><label>ป่วย</label><input type="number" id="sick" value="0" oninput="calculate()"></div>
        </div>

        <div class="calc-result">
            รวมมาเรียน: <span id="presentText">40</span> ชม. | 
            คิดเป็นร้อยละ: <span id="percentText">100.00</span>%
            <div id="statusNote" style="font-size: 0.85em; margin-top:5px;"></div>
        </div>

        <div id="loading">กำลังส่งข้อมูล...</div>

        <div class="btn-group">
            <button type="submit" class="btn-add-next">บันทึกและเพิ่มนักเรียนคนถัดไป</button>
            <button type="button" class="btn-reset" onclick="resetAll()">ล้างข้อมูลเพื่อเริ่มวิชาใหม่</button>
        </div>
    </form>
</div>

<div class="summary-container" id="summarySection">
    <div class="section-title">รายการที่บันทึกแล้วในรอบนี้</div>
    <table>
        <thead>
            <tr>
                <th>ชื่อ-นามสกุล</th>
                <th>ร้อยละ</th>
                <th>สถานะ</th>
            </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
    </table>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzjJ_QBp0CVQj2zGOl2CvmPnNcSfLeJl2OaAPwvtwdQKQnPHGd4kJXdc4NixLZVFQE5/exec';

    function calculate() {
        const total = parseFloat(document.getElementById('totalTime').value) || 0;
        const absent = parseFloat(document.getElementById('absent').value) || 0;
        const leave = parseFloat(document.getElementById('leave').value) || 0;
        const sick = parseFloat(document.getElementById('sick').value) || 0;

        const present = total - (absent + leave + sick);
        const percentage = total > 0 ? (present / total) * 100 : 0;

        document.getElementById('presentText').innerText = present;
        const pText = document.getElementById('percentText');
        pText.innerText = percentage.toFixed(2);

        const statusNote = document.getElementById('statusNote');
        if (percentage < 80) {
            pText.className = 'low-percent';
            statusNote.innerText = '⚠️ ต่ำกว่า 80% : หมดสิทธิ์สอบ';
            statusNote.style.color = '#d93025';
        } else {
            pText.className = '';
            statusNote.innerText = '✅ มีสิทธิ์สอบ';
            statusNote.style.color = '#188038';
        }
    }

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        document.getElementById('loading').style.display = 'block';
        const submitBtn = document.querySelector('.btn-add-next');
        submitBtn.disabled = true;

        const data = {
            teacher: document.getElementById('teacherName').value,
            dept: document.getElementById('department').value,
            courseID: document.getElementById('courseID').value,
            courseName: document.getElementById('courseName').value,
            class: document.getElementById('classRoom').value,
            studentID: document.getElementById('studentID').value,
            title: document.getElementById('title').value,
            studentName: document.getElementById('studentName').value,
            total: document.getElementById('totalTime').value,
            absent: document.getElementById('absent').value,
            leave: document.getElementById('leave').value,
            sick: document.getElementById('sick').value,
            present: document.getElementById('presentText').innerText,
            percent: document.getElementById('percentText').innerText
        };

        fetch(scriptURL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' })
        .then(() => {
            // แสดงตารางสรุป
            document.getElementById('summarySection').style.display = 'block';
            const tbody = document.getElementById('summaryBody');
            const row = tbody.insertRow(0);
            row.innerHTML = `
                <td>${data.title}${data.studentName}</td>
                <td>${data.percent}%</td>
                <td style="color:green; font-weight:bold;">บันทึกแล้ว</td>
            `;

            // ล้างเฉพาะส่วนข้อมูลนักเรียน
            document.getElementById('studentID').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('absent').value = '0';
            document.getElementById('leave').value = '0';
            document.getElementById('sick').value = '0';
            calculate();
            
            document.getElementById('loading').style.display = 'none';
            submitBtn.disabled = false;
            document.getElementById('studentID').focus();
        })
        .catch(err => {
            alert('เกิดข้อผิดพลาดในการบันทึก!');
            document.getElementById('loading').style.display = 'none';
            submitBtn.disabled = false;
        });
    });

    function resetAll() {
        if(confirm('ยืนยันล้างข้อมูลทั้งหมดเพื่อเปลี่ยนวิชาใช่หรือไม่?')) {
            location.reload();
        }
    }
</script>
</body>
</html>